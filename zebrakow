#!/bin/bash
#set -x

function metadata() {
    if [[ -e /etc/machine-info ]]; then
	source /etc/machine-info;
    fi
    echo "JOB_ID=$1"
    echo "CMDLINE=$(cat /proc/$(systemctl status $UNIT | grep Main\ PID: | sed s/\ Main\ PID:\ //g | awk '{print $1}')/comm)"
    echo "TIME=Running `systemctl status $UNIT | grep Active | sed s/\ \ \ Active:\ active\ \(running\)\ //g`"
    #echo "TIME=$(readlink /run/zebrakow/$JOB_ID/TIME)"
    echo "UNIT=$UNIT"
    echo "SLICE=$(systemctl show -p Slice $UNIT | sed s/Slice=//g )"
    echo "STATUS=$(systemctl status $UNIT | grep Status: | sed s/\ \ \ Status:\ //g)"
    echo "PID=$(systemctl status $UNIT | grep Main\ PID: | sed s/\ Main\ PID:\ //g | awk '{print $1}')"
    echo "--"
    echo "MEMORY=$(systemctl status $UNIT | grep Memory: | awk '{print $2}')"
    echo "TASKS=$(systemctl status $UNIT | grep Tasks: | sed s/\ \ \ \ Tasks:\ //g)"
    echo "CPU=$(systemctl status $UNIT | grep CPU: | awk '{print $2}')"
    echo "CGROUP=$(systemctl status $UNIT | grep CGroup: | awk '{print $2}')"
    echo "IP=$(systemctl status $UNIT | grep IP: | sed s/\ \ \ \ \ \ \ IP:\ //g)"
    echo "LOG_TARGET=$(systemctl show -p StandardOutput $UNIT | sed s/StandardOutput=//g)"
    echo "--"
    echo "MACHINE_HOSTNAME=$(hostname)"
    echo "MACHINE_ID=$(cat /etc/machine-id)"
    echo "MACHINE_PRETTY_HOSTNAME=$(echo $PRETTY_HOSTNAME)"
    echo "MACHINE_LOCATION=$(echo $LOCATION)"
}

function usage() {
    printf "Usage: %s [OPTIONS] {COMMAND}\n" $0
    printf "\nOptions:\n"
    printf "\t-l: List running jobs\n"
    printf "\t-h: Display this help\n"
    printf "\t-j: Operate on job\n"
    printf "\t\t-f: Tail the build log\n"
    printf "\t\t-m: Display job metadata\n"
    printf "\t\t-s: Display job status\n"
    printf "\t\t-i: Inspect the unit file of the job\n"
    printf "\t\t-k: Kill the job\n"
    printf "\t-S: Run under this slice unit\n"
    exit 0
}

while getopts "lhj:S:" opt; do
    case $opt in
	l)
	    if [[ ! -e /run/zebrakow ]]; then
		echo "/run/zebrakow not found!" >&2
		exit 1
	    fi
	    tree /run/zebrakow | head -n-1
	    NUM=$(ls -l /run/zebrakow | grep ^d | wc -l)
	    echo "$NUM job(s) listed"
	    exit 0
	    ;;
	h)
	    usage
	    ;;
	j)
    	    JOB_ID=$OPTARG
	    if [[ ! -e /run/zebrakow/$OPTARG ]]; then
		echo "No jobs with this JOB_ID!" >&2;
		exit 1
	    fi
	    echo
	    UNIT=$(readlink /run/zebrakow/$JOB_ID/UNIT)
	    echo "Unit $UNIT has JOB_ID $JOB_ID"
	    echo
	    shift $((OPTIND-1))
	    case $1 in
		-f) 
		    journalctl -f -u $UNIT
		    exit $?
		    ;;
		-m)
		    metadata $JOB_ID
		    exit 0
		    ;;
		-s)
		    systemctl status $UNIT
		    exit $?
		    ;;
		-i)
		    systemctl cat $UNIT
		    exit $?
		    ;;
		-k)
		    systemctl kill $UNIT
		    exit $?
		    ;;
		*)
		    echo "Unknown argument. Also, only a single argument may be passed." >&2
		    exit 1
		    ;;
	    esac
	    ;;
	S)
	    SLICE_UNIT=$OPTARG
	    ;;
	    
	:)
	    echo "Missing option argument for -$OPTARG" >&2;
	    exit 1
	    ;;
        *)
	    echo "Unknown option: -$OPTARG" >&2;
	    exit 1
	    ;;
    esac
done

shift $((OPTIND-1))
systemd-run -p ExecStartPre=/usr/lib/zebrakow/zebrakow-setup\ --start\ '$INVOCATION_ID' -p Environment=HOME=/root -p ExecStopPost=/usr/lib/zebrakow/zebrakow-setup\ --stop\ '$INVOCATION_ID' $@
